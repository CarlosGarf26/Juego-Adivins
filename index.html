
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta name="theme-color" content="#db2777" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Chilango Guess" />
    <meta name="description" content="Juego de adivinanzas con jerga mexicana." />
    
    <link rel="manifest" href="/manifest.json" />
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1865/1865626.png" />
    
    <title>Chilango Guess</title>
    
    <!-- LibrerÃ­as Externas (UMD - MÃ¡s estables) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (Globales) -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Babel para transpilar JSX en vivo -->
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      body {
        overscroll-behavior: none;
        touch-action: none;
        user-select: none;
        -webkit-user-select: none;
        background-color: #111827;
      }
      /* AnimaciÃ³n del tÃ­tulo */
      @keyframes title-pulse {
        0%, 100% { transform: rotate(-2deg) scale(1); text-shadow: 0 4px 0 rgba(0,0,0,0.3); }
        50% { transform: rotate(-2deg) scale(1.05); text-shadow: 0 10px 20px rgba(253, 224, 71, 0.6); }
      }
      #error-console {
          display: none;
          position: fixed;
          bottom: 0;
          left: 0;
          width: 100%;
          background: rgba(127, 29, 29, 0.95);
          color: white;
          font-family: monospace;
          padding: 10px;
          font-size: 12px;
          z-index: 9999;
          max-height: 50vh;
          overflow-y: auto;
          white-space: pre-wrap;
      }
    </style>

    <script>
        // ConfiguraciÃ³n global y manejo de errores
        window.process = { env: { NODE_ENV: 'development', API_KEY: '' } };
        
        window.onerror = function(message, source, lineno, colno, error) {
            const consoleEl = document.getElementById('error-console');
            const loaderMsg = document.getElementById('loader-msg');
            const spinner = document.getElementById('loader-spinner');
            
            if (consoleEl) {
                consoleEl.style.display = 'block';
                consoleEl.innerText += `[ERROR] ${message}\nEn: ${source}:${lineno}\n`;
            }
            if (loaderMsg) {
                loaderMsg.innerText = "Â¡CHALE! ALGO TRONÃ“.";
                loaderMsg.style.color = "#fca5a5";
            }
            if (spinner) spinner.style.borderColor = "red";
        };

        // Timeout de seguridad
        setTimeout(() => {
            const loader = document.getElementById('loader-spinner');
            if (loader) {
                document.getElementById('retry-btn').style.display = 'block';
                document.getElementById('loader-msg').innerText = "Â¿Se pasmÃ³? Intenta reiniciar.";
            }
        }, 8000);
        
        function hardReset() {
            if (navigator.serviceWorker) {
                navigator.serviceWorker.getRegistrations().then(function(registrations) {
                    for(let registration of registrations) {
                        registration.unregister();
                    }
                });
            }
            localStorage.clear();
            sessionStorage.clear();
            // Forzar recarga desde el servidor ignorando cachÃ©
            window.location.reload(true);
        }
    </script>
  </head>
  <body class="bg-gray-900 text-white h-screen w-screen overflow-hidden">
    <div id="error-console">ERRORES DETECTADOS:<br></div>

    <div id="root" class="h-full w-full">
        <!-- Loader inicial HTML puro -->
        <div class="flex flex-col items-center justify-center h-full bg-indigo-950 px-4 text-center">
            <div id="loader-spinner" class="w-16 h-16 border-4 border-pink-500 border-t-transparent rounded-full animate-spin mb-4"></div>
            <h2 id="loader-msg" class="text-white font-bold tracking-widest animate-pulse mb-8">CARGANDO BARRIO...</h2>
            
            <button id="retry-btn" onclick="window.location.reload()" class="hidden bg-white/10 border border-white/20 text-white px-6 py-2 rounded-full mb-4">
                Recargar PÃ¡gina
            </button>
             <button onclick="hardReset()" class="text-xs text-gray-400 underline mt-8 opacity-60">
                Borrar datos y reiniciar (Hard Reset)
            </button>
        </div>
    </div>

    <!-- LÃ“GICA DEL JUEGO INCRUSTADA -->
    <!-- data-type="module" permite usar import para librerÃ­as modernas dentro de Babel -->
    <script type="text/babel" data-type="module" data-presets="react,typescript">
// IMPORTANTE: React y ReactDOM ya estÃ¡n cargados globalmente como 'React' y 'ReactDOM'
// No usamos 'import React from ...' para evitar errores de mÃ³dulos.
const { useState, useEffect, useRef, useCallback } = React;

// Importamos SOLO la librerÃ­a de Gemini como mÃ³dulo (es moderna)
import { GoogleGenAI, Type } from "https://esm.sh/@google/genai@0.2.1";

// --- TYPES ---
enum GameState {
  IDLE = 'IDLE',
  LOADING = 'LOADING',
  PLAYING = 'PLAYING',
  FINISHED = 'FINISHED'
}

interface WordCard {
  word: string;
  definition: string;
  example: string;
}

interface GameResult {
  word: string;
  status: 'correct' | 'pass';
}

type Difficulty = 'facil' | 'barrio' | 'experto';

// --- SERVICE ---
const SYSTEM_INSTRUCTION = `
Eres un experto en cultura popular mexicana y jerga de la Ciudad de MÃ©xico (chilango). 
Generas palabras o frases para un juego de adivinanzas (Heads Up). 
Las definiciones deben ser graciosas pero claras. 
Los ejemplos deben sonar 100% autÃ©nticos de la CDMX.
`;

// Helper para detectar API Key
const getApiKey = () => process.env.API_KEY || window.process?.env?.API_KEY;

const fetchSlangWords = async (difficulty: Difficulty): Promise<WordCard[]> => {
  const apiKey = getApiKey();
  if (!apiKey) {
      console.warn("API KEY no encontrada. Usando modo offline.");
      return getFallbackWords(difficulty);
  }

  const ai = new GoogleGenAI({ apiKey: apiKey });
  
  let promptContext = "";
  switch (difficulty) {
    case 'facil': promptContext = "palabras muy comunes (ej. Tacos, Metro, Guajolota)."; break;
    case 'barrio': promptContext = "jerga callejera nivel medio (ej. Chale, CÃ¡mara, Poca m...)."; break;
    case 'experto': promptContext = "frases complejas, albures ligeros o modismos antiguos (ej. Sepa la bola, A darle que es mole de olla)."; break;
  }

  const prompt = `Genera una lista de 15 palabras o frases de la CDMX. Nivel: ${difficulty}. Contexto: ${promptContext}`;

  try {
    const response = await ai.models.generateContent({
      model: "gemini-3-pro-preview",
      contents: prompt,
      config: {
        systemInstruction: SYSTEM_INSTRUCTION,
        responseMimeType: "application/json",
        responseSchema: {
          type: Type.ARRAY,
          items: {
            type: Type.OBJECT,
            properties: {
              word: { type: Type.STRING },
              definition: { type: Type.STRING },
              example: { type: Type.STRING }
            },
            required: ["word", "definition", "example"]
          }
        }
      }
    });

    const text = response.text;
    return text ? JSON.parse(text) : getFallbackWords(difficulty);
  } catch (error) {
    console.error("Gemini Error:", error);
    return getFallbackWords(difficulty);
  }
};

const getFallbackWords = (difficulty: Difficulty) => {
    return [
      { word: "Chale", definition: "ExpresiÃ³n de decepciÃ³n", example: "Â¡Chale, ya se acabÃ³ el gas!" },
      { word: "CÃ¡mara", definition: "Acuerdo o despedida", example: "CÃ¡mara, ahÃ­ nos vemos." },
      { word: "Chamba", definition: "El trabajo", example: "Tengo un buen de chamba." },
      { word: "Chela", definition: "Una cerveza frÃ­a", example: "Vamos por unas chelas." },
      { word: "Neta", definition: "La pura verdad", example: "Â¿Es neta lo que me dices?" },
      { word: "Aguas", definition: "Â¡Cuidado!", example: "Â¡Aguas con el perro!" },
      { word: "Caer el 20", definition: "Entender algo de repente", example: "Apenas me cayÃ³ el 20." },
      { word: "Valedor", definition: "Amigo o compaÃ±ero", example: "Â¿QuÃ© pasÃ³ mi valedor?" },
      { word: "A poco", definition: "ExpresiÃ³n de incredulidad", example: "Â¡A poco te ganaste la loterÃ­a!" },
      { word: "Sepa la bola", definition: "QuiÃ©n sabe", example: "Â¿DÃ³nde estÃ¡ Juan? Â¡Sepa la bola!" }
    ];
};

// --- HOOKS ---
const useGameSensor = (isActive: boolean, onCorrect: () => void, onPass: () => void) => {
  const [hasPermission, setHasPermission] = useState(false);
  const lastAction = useRef<'neutral' | 'action'>('neutral');

  const handleOrientation = useCallback((event: DeviceOrientationEvent) => {
    if (!isActive) return;
    const { gamma } = event; 
    if (gamma === null) return;

    const absGamma = Math.abs(gamma);

    // LÃ³gica para detectar inclinaciÃ³n (telÃ©fono en la frente en landscape)
    if (absGamma < 30 && lastAction.current === 'neutral') {
      onCorrect();
      lastAction.current = 'action';
    } else if (absGamma > 140 && lastAction.current === 'neutral') {
      onPass();
      lastAction.current = 'action';
    } else if (absGamma > 50 && absGamma < 120) {
      lastAction.current = 'neutral';
    }
  }, [isActive, onCorrect, onPass]);

  const requestAccess = async () => {
    if (typeof (DeviceOrientationEvent as any).requestPermission === 'function') {
      try {
          const res = await (DeviceOrientationEvent as any).requestPermission();
          if (res === 'granted') {
            setHasPermission(true);
            window.addEventListener('deviceorientation', handleOrientation);
          }
      } catch(e) { console.error(e); }
    } else {
      setHasPermission(true);
      window.addEventListener('deviceorientation', handleOrientation);
    }
  };

  useEffect(() => {
    return () => window.removeEventListener('deviceorientation', handleOrientation);
  }, [handleOrientation]);

  return { hasPermission, requestAccess };
};

// --- MAIN COMPONENT ---
const App = () => {
  const [gameState, setGameState] = useState(GameState.IDLE);
  const [deck, setDeck] = useState([]);
  const [currentIndex, setCurrentIndex] = useState(0);
  const [results, setResults] = useState([]);
  const [difficulty, setDifficulty] = useState('barrio');
  const [timeLeft, setTimeLeft] = useState(60);
  const [feedback, setFeedback] = useState(null);
  const [isPortrait, setIsPortrait] = useState(window.innerHeight > window.innerWidth);
  const [installPrompt, setInstallPrompt] = useState(null);
  const [hasApiKey, setHasApiKey] = useState(false);

  const timerRef = useRef(null);

  useEffect(() => {
    const checkSize = () => setIsPortrait(window.innerHeight > window.innerWidth);
    window.addEventListener('resize', checkSize);
    
    // Check Key
    setHasApiKey(!!getApiKey());

    // Capturar evento de instalaciÃ³n
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      setInstallPrompt(e);
    });
    
    return () => window.removeEventListener('resize', checkSize);
  }, []);

  const handleInstall = async () => {
    if (!installPrompt) return;
    installPrompt.prompt();
    const { outcome } = await installPrompt.userChoice;
    if (outcome === 'accepted') setInstallPrompt(null);
  };

  const playSound = (freq) => {
    try {
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      if (!AudioContext) return;
      const ctx = new AudioContext();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.frequency.setValueAtTime(freq, ctx.currentTime);
      gain.gain.setValueAtTime(0.1, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.2);
      osc.start();
      osc.stop(ctx.currentTime + 0.2);
    } catch(e) {}
  };

  const handleCorrect = useCallback(() => {
    if (feedback) return;
    setFeedback('correct');
    playSound(800);
    setResults(prev => [...prev, { word: deck[currentIndex].word, status: 'correct' }]);
    setTimeout(nextCard, 800);
  }, [currentIndex, deck, feedback]);

  const handlePass = useCallback(() => {
    if (feedback) return;
    setFeedback('pass');
    playSound(300);
    setResults(prev => [...prev, { word: deck[currentIndex].word, status: 'pass' }]);
    setTimeout(nextCard, 800);
  }, [currentIndex, deck, feedback]);

  const nextCard = () => {
    setFeedback(null);
    if (currentIndex < deck.length - 1) {
      setCurrentIndex(prev => prev + 1);
    } else {
      finishGame();
    }
  };

  const finishGame = () => {
    if (timerRef.current) clearInterval(timerRef.current);
    setGameState(GameState.FINISHED);
  };

  const { hasPermission, requestAccess } = useGameSensor(
    gameState === GameState.PLAYING && !feedback,
    handleCorrect,
    handlePass
  );

  const startGame = async () => {
    setGameState(GameState.LOADING);
    const words = await fetchSlangWords(difficulty);
    setDeck(words);
    setCurrentIndex(0);
    setResults([]);
    setTimeLeft(60);
    setGameState(GameState.PLAYING);
    
    timerRef.current = window.setInterval(() => {
      setTimeLeft(prev => {
        if (prev <= 1) {
          finishGame();
          return 0;
        }
        return prev - 1;
      });
    }, 1000);
  };

  if (isPortrait && gameState === GameState.PLAYING) {
    return (
      <div className="flex flex-col items-center justify-center h-screen bg-black text-white text-center p-8">
        <div className="text-8xl animate-bounce mb-4">ðŸ”„</div>
        <h2 className="text-3xl font-black text-pink-500 uppercase">Â¡Gira el fon!</h2>
        <p className="mt-4 text-gray-400">El barrio se ve mejor en horizontal.</p>
      </div>
    );
  }

  if (gameState === GameState.IDLE) {
    return (
      <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-tr from-indigo-900 via-purple-900 to-pink-800 p-6 text-center">
        
        <h1 
          className="text-7xl font-black text-yellow-300 mb-2 italic tracking-tighter"
          style={{ animation: 'title-pulse 2s infinite ease-in-out' }}
        >
          Â¡ADIVINA!
        </h1>
        <h2 className="text-3xl font-bold text-white mb-6 tracking-widest uppercase text-pink-300">EdiciÃ³n Chilanga</h2>

        {!hasApiKey && (
           <div className="bg-yellow-500/20 border border-yellow-500/50 rounded-full px-4 py-1 mb-6">
              <span className="text-yellow-200 text-xs font-bold uppercase tracking-wider">Modo Offline (Palabras limitadas)</span>
           </div>
        )}
        
        <div className="bg-white/10 backdrop-blur-xl p-6 rounded-3xl border border-white/20 w-full max-w-md shadow-2xl mb-8">
          <p className="text-white text-base mb-4 leading-relaxed">
            Pon el cel en tu frente y que la banda te ayude.
          </p>
          <div className="space-y-4">
            <span className="text-xs font-bold text-pink-300 uppercase tracking-widest block">Nivel de Barrio</span>
            <div className="flex gap-2">
              {(['facil', 'barrio', 'experto']).map(d => (
                <button 
                  key={d}
                  onClick={() => setDifficulty(d)}
                  className={`flex-1 py-3 rounded-xl font-black uppercase transition-all text-sm ${difficulty === d ? 'bg-yellow-400 text-purple-900 scale-105 shadow-lg' : 'bg-white/5 text-white/50 hover:bg-white/10'}`}
                >
                  {d}
                </button>
              ))}
            </div>
          </div>
        </div>

        <div className="flex flex-col gap-4 w-full max-w-xs">
            {!hasPermission ? (
            <button onClick={requestAccess} className="bg-pink-600 hover:bg-pink-500 text-white font-black py-4 px-8 rounded-2xl text-xl shadow-xl active:scale-95 transition-all w-full">
                ACTIVAR SENSORES
            </button>
            ) : (
            <button onClick={startGame} className="bg-yellow-400 hover:bg-yellow-300 text-indigo-900 font-black py-4 px-8 rounded-2xl text-2xl shadow-xl animate-pulse active:scale-95 transition-all w-full">
                Â¡DALE!
            </button>
            )}

            {installPrompt && (
                <button onClick={handleInstall} className="text-white/60 hover:text-white underline text-sm uppercase tracking-widest mt-2">
                    Instalar App
                </button>
            )}
        </div>
      </div>
    );
  }

  if (gameState === GameState.LOADING) {
    return (
      <div className="flex flex-col items-center justify-center h-screen bg-indigo-950">
        <div className="w-20 h-20 border-8 border-pink-500 border-t-transparent rounded-full animate-spin mb-6"></div>
        <p className="text-white text-2xl font-black animate-pulse tracking-widest uppercase">Afilando el colmillo...</p>
      </div>
    );
  }

  if (gameState === GameState.PLAYING) {
    const card = deck[currentIndex];
    let bg = "bg-indigo-600";
    if (feedback === 'correct') bg = "bg-green-500";
    if (feedback === 'pass') bg = "bg-orange-500";

    return (
      <div className={`h-screen w-screen flex flex-col items-center justify-center transition-colors duration-300 ${bg} relative overflow-hidden`}>
        <div className="absolute top-4 right-8 bg-black/40 px-4 py-2 rounded-full border border-white/20">
          <span className={`text-3xl font-black ${timeLeft < 10 ? 'text-red-400 animate-ping' : 'text-white'}`}>{timeLeft}s</span>
        </div>

        {/* Zonas tÃ¡ctiles */}
        <div className="flex w-full h-full absolute inset-0 z-0">
            <div className="w-1/2 h-full flex items-center justify-start pl-12 active:bg-white/10" onClick={handleCorrect}>
                <span className="text-white/10 font-black text-6xl transform -rotate-90 pointer-events-none">CORRECTO</span>
            </div>
            <div className="w-1/2 h-full flex items-center justify-end pr-12 active:bg-white/10" onClick={handlePass}>
                <span className="text-white/10 font-black text-6xl transform -rotate-90 pointer-events-none">PASAR</span>
            </div>
        </div>

        <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none p-4 z-10">
          {feedback ? (
            <div className="text-9xl font-black text-white uppercase drop-shadow-2xl animate-bounce">
              {feedback === 'correct' ? 'Â¡ESO!' : 'PASO'}
            </div>
          ) : (
            <div className="text-center animate-in zoom-in fade-in duration-500 w-full max-w-4xl">
              <h1 className="text-8xl md:text-9xl font-black text-white drop-shadow-2xl mb-6 leading-none break-words uppercase">
                {card?.word}
              </h1>
              <div className="bg-black/20 backdrop-blur-sm p-6 rounded-3xl border border-white/10 mx-auto max-w-2xl">
                <p className="text-3xl text-yellow-300 font-bold mb-2">"{card?.definition}"</p>
                <p className="text-xl text-white/70 italic italic tracking-tight">Ej: {card?.example}</p>
              </div>
            </div>
          )}
        </div>
      </div>
    );
  }

  if (gameState === GameState.FINISHED) {
    const score = results.filter(r => r.status === 'correct').length;
    return (
      <div className="min-h-screen bg-indigo-950 text-white p-8 flex flex-col items-center overflow-y-auto">
        <h2 className="text-5xl font-black text-yellow-400 mt-10 mb-2 uppercase italic">Â¡Rifa total!</h2>
        <div className="text-8xl font-black mb-10">{score} <span className="text-2xl text-indigo-300 font-normal">puntos</span></div>
        
        <div className="w-full max-w-md space-y-3 mb-10">
          {results.map((res, i) => (
            <div key={i} className={`flex justify-between items-center p-4 rounded-2xl border ${res.status === 'correct' ? 'bg-green-900/30 border-green-500/50' : 'bg-red-900/30 border-red-500/50'}`}>
              <span className="text-2xl font-bold">{res.word}</span>
              <span className={`font-black uppercase text-sm ${res.status === 'correct' ? 'text-green-400' : 'text-red-400'}`}>
                {res.status === 'correct' ? 'âœ“' : 'âœ—'}
              </span>
            </div>
          ))}
        </div>

        <button onClick={() => setGameState(GameState.IDLE)} className="bg-white text-indigo-900 font-black py-5 px-16 rounded-2xl text-2xl shadow-xl hover:scale-105 transition-all mb-20">
          OTRA VEZ
        </button>
      </div>
    );
  }

  return null;
};

// Render seguro con manejo de errores
try {
    const rootElement = document.getElementById('root');
    if (rootElement) {
        const root = ReactDOM.createRoot(rootElement);
        root.render(<App />);
    }
} catch (err) {
    console.error("Mount error:", err);
    document.getElementById('root').innerHTML = '<div style="color:red; padding:20px;">Error grave al iniciar: ' + err.message + '</div>';
}
    </script>
  </body>
</html>
